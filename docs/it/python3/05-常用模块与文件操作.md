# Python 常用模块与文件操作

## 一、文件操作

### 1.1 基本文件操作

```python
# 写入文件
with open('test.txt', 'w', encoding='utf-8') as f:
    f.write('Hello, World!\n')
    f.write('Python 文件操作')

# 读取文件
with open('test.txt', 'r', encoding='utf-8') as f:
    content = f.read()
    print(content)

# 逐行读取
with open('test.txt', 'r', encoding='utf-8') as f:
    for line in f:
        print(line.strip())

# 读取所有行
with open('test.txt', 'r', encoding='utf-8') as f:
    lines = f.readlines()
    print(lines)
```

### 1.2 文件打开模式

```python
# 不同打开模式
with open('test.txt', 'r', encoding='utf-8') as f:  # 只读
    pass

with open('test.txt', 'w', encoding='utf-8') as f:  # 写入（覆盖）
    pass

with open('test.txt', 'a', encoding='utf-8') as f:  # 追加
    pass

with open('test.txt', 'r+', encoding='utf-8') as f:  # 读写
    pass

with open('test.txt', 'rb') as f:  # 二进制读取
    pass

with open('test.txt', 'wb') as f:  # 二进制写入
    pass
```

### 1.3 文件路径操作

```python
import os
from pathlib import Path

# os 模块
print(os.getcwd())  # 获取当前工作目录
print(os.listdir('.'))  # 列出当前目录文件
os.makedirs('new_dir', exist_ok=True)  # 创建目录
os.remove('test.txt')  # 删除文件
os.rmdir('new_dir')  # 删除空目录

# pathlib 模块（推荐）
path = Path('test.txt')
print(path.exists())  # 检查文件是否存在
print(path.is_file())  # 是否为文件
print(path.is_dir())  # 是否为目录
print(path.name)  # 文件名
print(path.suffix)  # 文件扩展名
print(path.parent)  # 父目录

# 路径拼接
new_path = Path('data') / 'subdir' / 'file.txt'
print(new_path)
```

### 1.4 实际应用场景

```python
# 批量处理文件
import os
from pathlib import Path

def process_files(directory):
    for file_path in Path(directory).glob('*.txt'):
        print(f"处理文件：{file_path}")
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        # 处理文件内容
        print(f"文件大小：{file_path.stat().st_size} 字节")

# 创建日志文件
import time
from datetime import datetime

def write_log(message, log_file='app.log'):
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    with open(log_file, 'a', encoding='utf-8') as f:
        f.write(f"[{timestamp}] {message}\n")

write_log("应用启动")
write_log("处理用户请求")

# 配置文件读写（JSON）
import json

config = {
    "database": {
        "host": "localhost",
        "port": 5432,
        "name": "mydb"
    },
    "app": {
        "debug": True,
        "port": 8000
    }
}

# 写入配置
with open('config.json', 'w', encoding='utf-8') as f:
    json.dump(config, f, indent=2, ensure_ascii=False)

# 读取配置
with open('config.json', 'r', encoding='utf-8') as f:
    loaded_config = json.load(f)
    print(loaded_config)
```

## 二、os 模块

### 2.1 系统信息

```python
import os
import platform

# 系统信息
print(f"操作系统：{platform.system()}")
print(f"系统版本：{platform.release()}")
print(f"处理器：{platform.processor()}")
print(f"Python 版本：{platform.python_version()}")

# 环境变量
print(f"用户目录：{os.path.expanduser('~')}")
print(f"临时目录：{os.path.gettempdir()}")
```

### 2.2 目录操作

```python
import os
from pathlib import Path

# 创建目录
os.makedirs('data/subdir', exist_ok=True)
Path('data/subdir2').mkdir(parents=True, exist_ok=True)

# 遍历目录
for root, dirs, files in os.walk('data'):
    print(f"目录：{root}")
    print(f"子目录：{dirs}")
    print(f"文件：{files}")
    print("---")

# 获取目录信息
stat = os.stat('data')
print(f"大小：{stat.st_size} 字节")
print(f"创建时间：{stat.st_ctime}")
print(f"修改时间：{stat.st_mtime}")
```

### 2.3 进程管理

```python
import os
import subprocess

# 获取进程 ID
print(f"当前进程 ID：{os.getpid()}")
print(f"父进程 ID：{os.getppid()}")

# 执行系统命令
result = subprocess.run(['ls', '-l'], capture_output=True, text=True)
print(result.stdout)

# 执行命令并获取返回码
result = subprocess.run(['python', '--version'])
print(f"返回码：{result.returncode}")
```

## 三、sys 模块

### 3.1 系统参数

```python
import sys

# Python 版本
print(f"Python 版本：{sys.version}")
print(f"版本信息：{sys.version_info}")

# 解释器路径
print(f"解释器路径：{sys.executable}")

# 模块搜索路径
print(f"模块搜索路径：{sys.path}")
```

### 3.2 命令行参数

```python
import sys

# 命令行参数
print(f"脚本名称：{sys.argv[0]}")
print(f"参数列表：{sys.argv[1:]}")

# 使用示例：python script.py arg1 arg2
# sys.argv = ['script.py', 'arg1', 'arg2']
```

### 3.3 标准输入输出

```python
import sys

# 标准输入
print("请输入内容：")
user_input = sys.stdin.readline().strip()
print(f"你输入了：{user_input}")

# 标准输出
sys.stdout.write("标准输出\n")
sys.stderr.write("标准错误输出\n")

# 退出程序
if not user_input:
    sys.exit(1)
```

### 3.4 实际应用场景

```python
# 命令行工具
import sys
import argparse

def main():
    parser = argparse.ArgumentParser(description='文件处理工具')
    parser.add_argument('filename', help='要处理的文件名')
    parser.add_argument('--output', '-o', help='输出文件名')
    parser.add_argument('--verbose', '-v', action='store_true', help='详细输出')

    args = parser.parse_args()

    if args.verbose:
        print(f"处理文件：{args.filename}")

    with open(args.filename, 'r', encoding='utf-8') as f:
        content = f.read()

    if args.output:
        with open(args.output, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"结果已保存到：{args.output}")
    else:
        print(content)

if __name__ == '__main__':
    main()
```

## 四、datetime 模块

### 4.1 日期时间操作

```python
from datetime import datetime, date, time, timedelta

# 当前时间
now = datetime.now()
print(f"当前时间：{now}")
print(f"日期：{now.date()}")
print(f"时间：{now.time()}")

# 创建日期时间
dt = datetime(2024, 1, 1, 12, 30, 45)
print(f"指定时间：{dt}")

# 日期时间计算
tomorrow = now + timedelta(days=1)
print(f"明天：{tomorrow}")

one_week_ago = now - timedelta(weeks=1)
print(f"一周前：{one_week_ago}")
```

### 4.2 时间格式化

```python
from datetime import datetime

# 格式化输出
now = datetime.now()
print(now.strftime('%Y-%m-%d %H:%M:%S'))
print(now.strftime('%Y年%m月%d日 %H时%M分%S秒'))

# 解析字符串
date_str = '2024-01-01 12:30:45'
dt = datetime.strptime(date_str, '%Y-%m-%d %H:%M:%S')
print(f"解析结果：{dt}")
```

### 4.3 实际应用场景

```python
# 计算时间差
from datetime import datetime

def calculate_age(birth_date):
    today = datetime.now()
    age = today.year - birth_date.year
    if (today.month, today.day) < (birth_date.month, birth_date.day):
        age -= 1
    return age

birth_date = datetime(1990, 5, 15)
print(f"年龄：{calculate_age(birth_date)} 岁")

# 生成日志文件名
from datetime import datetime

def get_log_filename():
    return datetime.now().strftime('app_%Y%m%d_%H%M%S.log')

print(f"日志文件名：{get_log_filename()}")

# 定时任务
import time
from datetime import datetime

def run_at_time(target_time):
    while True:
        now = datetime.now()
        if now.hour == target_time.hour and now.minute == target_time.minute:
            print("执行定时任务")
            break
        time.sleep(10)

# run_at_time(time(14, 30))  # 在 14:30 执行
```

## 五、json 模块

### 5.1 JSON 编码与解码

```python
import json

# Python 对象转 JSON
data = {
    "name": "张三",
    "age": 25,
    "skills": ["Python", "JavaScript", "SQL"],
    "active": True
}

json_str = json.dumps(data, indent=2, ensure_ascii=False)
print(json_str)

# JSON 转 Python 对象
parsed_data = json.loads(json_str)
print(parsed_data)
```

### 5.2 文件读写

```python
import json

# 写入 JSON 文件
data = {
    "users": [
        {"id": 1, "name": "张三", "email": "zhangsan@example.com"},
        {"id": 2, "name": "李四", "email": "lisi@example.com"}
    ]
}

with open('users.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, indent=2, ensure_ascii=False)

# 读取 JSON 文件
with open('users.json', 'r', encoding='utf-8') as f:
    loaded_data = json.load(f)
    print(loaded_data)
```

### 5.3 实际应用场景

```python
# 配置文件管理
import json
from pathlib import Path

class ConfigManager:
    def __init__(self, config_file='config.json'):
        self.config_file = Path(config_file)
        self.config = self.load_config()

    def load_config(self):
        if self.config_file.exists():
            with open(self.config_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return {}

    def save_config(self):
        with open(self.config_file, 'w', encoding='utf-8') as f:
            json.dump(self.config, f, indent=2, ensure_ascii=False)

    def get(self, key, default=None):
        return self.config.get(key, default)

    def set(self, key, value):
        self.config[key] = value
        self.save_config()

# 使用配置管理器
config = ConfigManager()
config.set('database.host', 'localhost')
config.set('database.port', 5432)
print(config.get('database.host'))
```

## 六、re 模块（正则表达式）

### 6.1 基本匹配

```python
import re

# 匹配字符串
text = "Hello, World! 123"
pattern = r"Hello"

match = re.search(pattern, text)
if match:
    print(f"找到匹配：{match.group()}")

# 查找所有匹配
numbers = re.findall(r'\d+', text)
print(f"数字：{numbers}")

# 替换
new_text = re.sub(r'\d+', 'XXX', text)
print(f"替换后：{new_text}")
```

### 6.2 常用模式

```python
import re

# 邮箱验证
email = "user@example.com"
pattern = r'^[\w\.-]+@[\w\.-]+\.\w+$'
if re.match(pattern, email):
    print("邮箱格式正确")

# 手机号验证
phone = "13800138000"
pattern = r'^1[3-9]\d{9}$'
if re.match(pattern, phone):
    print("手机号格式正确")

# URL 提取
text = "访问 https://www.example.com 和 http://test.com"
urls = re.findall(r'https?://[\w\.-]+', text)
print(f"URLs：{urls}")
```

### 6.3 实际应用场景

```python
# 数据清洗
import re

def clean_text(text):
    # 去除多余空格
    text = re.sub(r'\s+', ' ', text)
    # 去除特殊字符
    text = re.sub(r'[^\w\s]', '', text)
    return text.strip()

dirty_text = "  Hello,   World!  @#$  "
clean_text = clean_text(dirty_text)
print(f"清洗后：{clean_text}")

# 提取信息
text = """
姓名：张三
年龄：25
邮箱：zhangsan@example.com
电话：13800138000
"""

info = {}
for line in text.strip().split('\n'):
    match = re.match(r'(.+)：(.+)', line)
    if match:
        key, value = match.groups()
        info[key.strip()] = value.strip()

print(info)
```

## 七、collections 模块

### 7.1 Counter

```python
from collections import Counter

# 统计元素出现次数
text = "hello world hello python"
words = text.split()
word_count = Counter(words)
print(word_count)  # Counter({'hello': 2, 'world': 1, 'python': 1})

# 最常见的元素
print(word_count.most_common(2))  # [('hello', 2), ('world', 1)]
```

### 7.2 defaultdict

```python
from collections import defaultdict

# 默认字典
dd = defaultdict(int)
dd['a'] += 1
dd['b'] += 2
print(dd)  # defaultdict(<class 'int'>, {'a': 1, 'b': 2})

# 分组
words = ['apple', 'banana', 'apricot', 'blueberry', 'cherry']
grouped = defaultdict(list)
for word in words:
    grouped[word[0]].append(word)

print(grouped)
# defaultdict(<class 'list'>, {'a': ['apple', 'apricot'], 'b': ['banana', 'blueberry'], 'c': ['cherry']})
```

### 7.3 namedtuple

```python
from collections import namedtuple

# 命名元组
Point = namedtuple('Point', ['x', 'y'])
p = Point(10, 20)
print(p.x, p.y)  # 10 20
print(p[0], p[1])  # 10 20

# 使用示例
Student = namedtuple('Student', ['name', 'age', 'grade'])
student = Student('张三', 20, '大二')
print(student.name)  # 张三
```

## 八、random 模块

### 8.1 随机数生成

```python
import random

# 随机整数
print(random.randint(1, 10))  # 1-10 之间的随机整数

# 随机浮点数
print(random.random())  # 0.0-1.0 之间的随机浮点数
print(random.uniform(1.0, 10.0))  # 1.0-10.0 之间的随机浮点数

# 随机选择
items = ['apple', 'banana', 'orange']
print(random.choice(items))  # 随机选择一个元素
print(random.sample(items, 2))  # 随机选择两个元素
random.shuffle(items)  # 随机打乱列表
print(items)
```

### 8.2 实际应用场景

```python
# 生成随机密码
import random
import string

def generate_password(length=12):
    chars = string.ascii_letters + string.digits + "!@#$%"
    password = ''.join(random.choice(chars) for _ in range(length))
    return password

print(f"随机密码：{generate_password()}")

# 随机抽样
import random

def random_sample(data, sample_size):
    return random.sample(data, min(sample_size, len(data)))

data = list(range(100))
sample = random_sample(data, 10)
print(f"随机样本：{sample}")
```

## 九、logging 模块

### 9.1 基本日志记录

```python
import logging

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    filename='app.log'
)

# 记录日志
logging.debug('调试信息')
logging.info('普通信息')
logging.warning('警告信息')
logging.error('错误信息')
logging.critical('严重错误')
```

### 9.2 高级日志配置

```python
import logging
from logging.handlers import RotatingFileHandler

# 创建日志记录器
logger = logging.getLogger('my_app')
logger.setLevel(logging.DEBUG)

# 文件处理器（自动轮转）
file_handler = RotatingFileHandler(
    'app.log',
    maxBytes=1024*1024,  # 1MB
    backupCount=5
)
file_handler.setLevel(logging.DEBUG)

# 控制台处理器
console_handler = logging.StreamHandler()
console_handler.setLevel(logging.INFO)

# 格式化器
formatter = logging.Formatter(
    '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
file_handler.setFormatter(formatter)
console_handler.setFormatter(formatter)

# 添加处理器
logger.addHandler(file_handler)
logger.addHandler(console_handler)

# 使用日志记录器
logger.debug('调试信息')
logger.info('普通信息')
logger.warning('警告信息')
logger.error('错误信息')
```

### 9.3 实际应用场景

```python
# 应用日志记录
import logging
from datetime import datetime

class AppLogger:
    def __init__(self, name):
        self.logger = logging.getLogger(name)
        self.logger.setLevel(logging.DEBUG)

        file_handler = logging.FileHandler(f'{name}.log')
        file_handler.setLevel(logging.DEBUG)

        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        file_handler.setFormatter(formatter)

        self.logger.addHandler(file_handler)

    def info(self, message):
        self.logger.info(message)

    def error(self, message):
        self.logger.error(message)

    def debug(self, message):
        self.logger.debug(message)

# 使用应用日志
logger = AppLogger('my_app')
logger.info('应用启动')
logger.debug('处理数据中...')
logger.error('发生错误')
```

## 十、面试常考题

### 10.1 文件读取方式的区别

**问题：read()、readline() 和 readlines() 有什么区别？**

**答案：**
| 方法 | 功能 | 返回值 | 适用场景 |
|------|------|--------|----------|
| read() | 读取全部内容 | 字符串 | 小文件 |
| readline() | 读取一行 | 字符串 | 逐行处理 |
| readlines() | 读取所有行 | 列表 | 需要随机访问 |

```python
with open('test.txt', 'r') as f:
    content = f.read()  # 全部内容

with open('test.txt', 'r') as f:
    line = f.readline()  # 一行

with open('test.txt', 'r') as f:
    lines = f.readlines()  # 所有行
```

### 10.2 os 和 pathlib 的区别

**问题：os 和 pathlib 模块有什么区别？**

**答案：**
| 特性 | os | pathlib |
|------|-----|---------|
| 风格 | 函数式 | 面向对象 |
| 可读性 | 较低 | 较高 |
| 跨平台 | 需要注意 | 自动处理 |
| 推荐度 | 传统 | 推荐 |

```python
# os
import os
path = os.path.join('data', 'file.txt')

# pathlib（推荐）
from pathlib import Path
path = Path('data') / 'file.txt'
```

### 10.3 JSON 序列化问题

**问题：哪些 Python 对象不能被 JSON 序列化？**

**答案：**
- datetime 对象
- set 集合
- 自定义类实例
- 复杂对象

```python
import json
from datetime import datetime

# 错误示例
data = {'date': datetime.now()}
# json.dumps(data)  # TypeError

# 解决方案
data = {'date': datetime.now().isoformat()}
json.dumps(data)  # 正确
```

### 10.4 正则表达式性能优化

**问题：如何优化正则表达式的性能？**

**答案：**
1. 使用预编译（re.compile）
2. 避免贪婪匹配
3. 使用非捕获组
4. 限制回溯

```python
import re

# 预编译
pattern = re.compile(r'\d+')
pattern.findall('123 456 789')

# 非贪婪匹配
text = '<div>content</div><div>more</div>'
re.findall(r'<div>.*?</div>', text)  # 非贪婪
```

## 十一、总结

### 11.1 关键要点

1. **文件操作**：使用 with 语句，注意编码
2. **os 模块**：系统交互，目录操作
3. **sys 模块**：系统参数，命令行参数
4. **datetime 模块**：日期时间处理
5. **json 模块**：数据序列化
6. **re 模块**：文本匹配和替换
7. **collections 模块**：高级数据结构
8. **random 模块**：随机数生成
9. **logging 模块**：日志记录

### 11.2 最佳实践

1. 使用 pathlib 替代 os.path
2. 文件操作使用 with 语句
3. JSON 处理注意编码问题
4. 正则表达式预编译
5. 日志记录合理配置级别
6. 随机数设置种子保证可复现
7. 使用 collections 高效处理数据

### 11.3 学习建议

1. 熟悉常用模块的 API
2. 多练习文件操作和数据处理
3. 掌握正则表达式的基本用法
4. 学习日志记录的最佳实践
5. 了解性能优化技巧
6. 阅读官方文档和示例代码
